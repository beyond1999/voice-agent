<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Role Chat · MVP</title>
<style>
  :root{
    --bg:#ffffff;
    --border:#e5e7eb;
    --user:#0a7cff;
    --assistant:#f1f5f9;
    --text:#0f172a;
    --muted:#64748b;
  }
  body{margin:0;background:var(--bg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC", sans-serif;
    color:var(--text);height:100vh;display:flex;flex-direction:column;}
  header{padding:14px 16px;border-bottom:1px solid var(--border);}  
  header h1{font-size:18px;margin:0}
  .row{display:flex;gap:10px;align-items:center;margin:8px 0;}
  .pill{background:#f1f5f9;padding:2px 8px;border-radius:999px;font-size:12px;color:#475569;}
  .muted{font-size:12px;color:var(--muted);}  
  .card{border:1px solid var(--border);padding:8px 12px;border-radius:10px;background:#f8fafc;margin:8px 0;}
  label{font-size:14px;font-weight:600;}
  select{flex:1;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:14px;}
  #chat{flex:1;overflow:auto;padding:14px 14px 0}
  .row.msg{align-items:flex-end;}
  .row.user{justify-content:flex-end}
  .avatar{width:34px;height:34px;border-radius:50%;flex:0 0 34px;display:grid;place-items:center;color:#fff;font-weight:700;}
  .avatar.user{background:var(--user)}
  .avatar.assistant{background:#94a3b8;font-size:18px}
  .bubble{max-width:min(78%,720px);padding:10px 12px;line-height:1.6;border-radius:14px;
    box-shadow:0 1px 1px rgba(0,0,0,.04);word-wrap:break-word;white-space:pre-wrap;}
  .bubble.user{background:var(--user);color:#fff;border-bottom-right-radius:6px;}
  .bubble.assistant{background:var(--assistant);color:var(--text);border-bottom-left-radius:6px;}
  .tools{display:flex;align-items:center;gap:6px;margin-left:4px;}
  .icon-btn{border:none;background:transparent;cursor:pointer;padding:4px;color:var(--muted);font-size:16px;}
  #composer{border-top:1px solid var(--border);padding:10px;display:flex;gap:8px;align-items:center;}
  #mic,#send,#reset{border:none;background:var(--user);color:#fff;padding:0 14px;height:40px;
    border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;}
  #mic.muted{background:#94a3b8}
  #reset{background:#94a3b8}
  #input{flex:1;height:40px;border:1px solid var(--border);border-radius:10px;
    padding:0 12px;font-size:15px;outline:none;}
</style>
</head>
<body>
  <header>
    <h1>AI Role Chat</h1>
    <div class="row">
      <span class="pill">MVP</span>
      <span class="muted">语音 → ASR → LLM → TTS（可选人设）</span>
    </div>
    <div class="row card">
      <label for="persona">选择角色（Persona）</label>
      <select id="persona"></select>
      <button id="reset">♻️ 重置</button>
    </div>
  </header>

  <div id="chat"></div>
  <div id="composer">
    <button id="mic" title="语音输入">🎤</button>
    <input id="input" placeholder="输入你的问题…" />
    <button id="send" title="发送">发送</button>
  </div>

<script>
  // ====== 后端接口 ======
  const LLM_URL = "http://127.0.0.1:8001/llm";
  const ASR_WS_URL = "ws://127.0.0.1:8000/ws_asr"; // 若你的后端是 /ws，请改成 /ws
  const TTS_URL = "http://127.0.0.1:8002/tts";     // 这里暂未使用（保留给你接 TTS 服务）

  // ====== 三个人设配置 ======
  const PERSONAS = {
    wukong: {
      label: "孙悟空（机灵俏皮）",
      avatar: "🐵",
      system: "你是一个机灵、俏皮、会自称‘俺老孙’的中文角色。风格轻快，爱用比喻，避免学术化长句。",
      greeting: "俺老孙来也！有啥难题尽管说，保你一个跟斗云就到~"
    },
    harry: {
      label: "哈利·波特（温暖机智）",
      avatar: "🧙‍♂️",
      system: "你是一位亲切机智的‘哈利·波特’风格中文角色。用温柔的方式解释问题，偶尔用一点魔法世界的比喻。",
      greeting: "你好！魔法世界的大门已经打开，我们从第一个问题开始吧。"
    },
    ironman: {
      label: "钢铁侠（理性自信）",
      avatar: "🤖",
      system: "你是一位托尼·斯塔克风格的中文角色：理性、自信、略带幽默。回答结构清晰，先结论后细节，并给出可执行建议。",
      greeting: "Jarvis…哦不，是我。说吧，要造点什么？"
    }
  };

  // ====== DOM 引用 ======
  const chat = document.getElementById('chat');
  const input = document.getElementById('input');
  const micBtn = document.getElementById('mic');
  const sendBtn = document.getElementById('send');
  const resetBtn = document.getElementById('reset');
  const personaSelect = document.getElementById('persona');

  // ====== 状态 ======
  let currentPersonaKey = localStorage.getItem('personaKey') || 'wukong';

  // ====== 工具函数 ======
  function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }
  async function playTTS(text, personaKey){
    try{
      const res = await fetch(TTS_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ text, persona: personaKey })
      });
      if(!res.ok){
        const errTxt = await res.text();
        throw new Error(`TTS error: ${res.status} ${errTxt}`);
      }
      const blob = await res.blob(); // audio/wav
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.play().catch(()=>{ /* 用户未交互可能被浏览器拦截 */ });
      return audio;
    }catch(e){
      console.error(e);
    }
  }

//   1// 修改：气泡上的“🔊”按钮绑定为调用 TTS_URL
//   function addMessage(role, text){
//     const row = document.createElement('div');
//     row.className = `row msg ${role}`;

//     const avatar = document.createElement('div');
//     avatar.className = `avatar ${role}`;
//     if(role === 'assistant'){
//       const p = PERSONAS[currentPersonaKey];
//       avatar.textContent = p.avatar;
//     } else {
//       avatar.textContent = '我';
//     }

//     const bubble = document.createElement('div');
//     bubble.className = `bubble ${role}`;
//     bubble.textContent = text;

//     row.appendChild(role==='user' ? bubble : avatar);
//     row.appendChild(role==='user' ? avatar : bubble);

//     if(role==='assistant'){
//       const tools = document.createElement('div'); tools.className='tools';
//       const speak = document.createElement('button'); speak.className='icon-btn'; speak.textContent='🔊';
//       speak.onclick = () => playTTS(text, currentPersonaKey);
//       tools.appendChild(speak); row.appendChild(tools);
//     }

//     chat.appendChild(row);
//     scrollToBottom();
//     saveHistory();
//   }

//   // 在 sendMessage() 里，收到 LLM 回复后，自动 TTS 一下（可选）
//   async function sendMessage(){
//     const text = input.value.trim(); if(!text) return;
//     addMessage('user', text); input.value = '';
//     const persona = PERSONAS[currentPersonaKey];
//     const messages = [
//       { role: 'system', content: persona.system },
//       { role: 'user', content: text }
//     ];
//     try{
//       const res = await fetch(LLM_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ messages }) });
//       const data = await res.json();
//       const reply = data.text || '[无回复]';
//       addMessage('assistant', reply);

//       // 自动播报（可注释掉）
//       playTTS(reply, currentPersonaKey);

//     }catch(err){ console.error(err); addMessage('assistant','[请求失败]'); }
//   }



  function addMessage(role, text){
    const row = document.createElement('div');
    row.className = `row msg ${role}`;

    const avatar = document.createElement('div');
    avatar.className = `avatar ${role}`;
    if(role === 'assistant'){
      const p = PERSONAS[currentPersonaKey];
      avatar.textContent = p.avatar;
    } else {
      avatar.textContent = '我';
    }

    const bubble = document.createElement('div');
    bubble.className = `bubble ${role}`;
    bubble.textContent = text;

    row.appendChild(role==='user' ? bubble : avatar);
    row.appendChild(role==='user' ? avatar : bubble);

    if(role==='assistant'){
      const tools = document.createElement('div'); tools.className='tools';
      const speak = document.createElement('button'); speak.className='icon-btn'; speak.textContent='🔊';
      speak.onclick = () => { const u = new SpeechSynthesisUtterance(text); u.lang='zh-CN'; speechSynthesis.speak(u); };
      tools.appendChild(speak); row.appendChild(tools);
    }

    chat.appendChild(row);
    scrollToBottom();
    saveHistory();
  }

  async function sendMessage(){
    const text = input.value.trim(); if(!text) return;
    addMessage('user', text); input.value = '';
    const persona = PERSONAS[currentPersonaKey];
    const messages = [
      { role: 'system', content: persona.system },
      { role: 'user', content: text }
    ];
    try{
      const res = await fetch(LLM_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ messages }) });
      const data = await res.json();
      addMessage('assistant', data.text || '[无回复]');
    }catch(err){ console.error(err); addMessage('assistant','[请求失败]'); }
  }

  sendBtn.onclick = sendMessage;
  input.addEventListener('keydown', e => { if(e.key === 'Enter') sendMessage(); });

  // ====== WebSocket ASR（可保持你原有后端协议） ======
  let ws=null, audioContext=null, mediaStream=null, workletNode=null, micOn=false, buffer=new Float32Array(0);
  const FRAME=320; // 20ms @ 16kHz

  function floatTo16BitPCM(float32){
    const buf = new ArrayBuffer(float32.length*2);
    const view = new DataView(buf);
    let o=0; for(let i=0;i<float32.length;i++,o+=2){
      let s = Math.max(-1, Math.min(1, float32[i]));
      view.setInt16(o, s<0 ? s*0x8000 : s*0x7fff, true);
    }
    return buf;
  }

  function downsampleTo16kHz(float32, inRate){
    if(inRate === 16000) return float32;
    const ratio = inRate / 16000;
    const newLen = Math.floor(float32.length / ratio);
    const res = new Float32Array(newLen);
    let o=0, ib=0;
    while(o<newLen){
      const next = Math.floor((o+1)*ratio);
      let acc=0, c=0;
      for(let i=ib;i<next && i<float32.length;i++){ acc += float32[i]; c++; }
      res[o] = acc / (c||1);
      o++; ib = next;
    }
    return res;
  }

  async function startMic(){
    ws = new WebSocket(ASR_WS_URL); ws.binaryType = 'arraybuffer';
    ws.onopen = () => { micBtn.textContent = '🛑'; };
    ws.onmessage = ev => {
      try{
        const msg = JSON.parse(ev.data);
        if(msg.type === 'partial'){
          input.value = msg.text;
        } else if(msg.type === 'final'){
          input.value = msg.text; sendMessage();
        }
      }catch(e){}
    };
    ws.onclose = () => { micBtn.textContent = '🎤'; stopMic(); };

    mediaStream = await navigator.mediaDevices.getUserMedia({ audio:{ channelCount:1 }, video:false });
    audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(mediaStream);

    const workletCode = `class PCMWorklet extends AudioWorkletProcessor{process(inputs){if(inputs[0]&&inputs[0][0]){this.port.postMessage(inputs[0][0],[inputs[0][0].buffer]);}return true;}}registerProcessor('pcm-worklet',PCMWorklet);`;
    const blob = new Blob([workletCode],{type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    await audioContext.audioWorklet.addModule(url);
    workletNode = new AudioWorkletNode(audioContext,'pcm-worklet');
    workletNode.port.onmessage = ev => {
      const block = ev.data;
      const ds = downsampleTo16kHz(block, audioContext.sampleRate);
      const tmp = new Float32Array(buffer.length + ds.length);
      tmp.set(buffer,0); tmp.set(ds, buffer.length); buffer = tmp;
      while(buffer.length >= FRAME){
        const frame = buffer.slice(0, FRAME); buffer = buffer.slice(FRAME);
        ws.send(floatTo16BitPCM(frame));
      }
    };
    source.connect(workletNode); micOn = true;
  }

  function stopMic(){
    micOn = false;
    if(workletNode){ workletNode.disconnect(); workletNode = null; }
    if(audioContext){ audioContext.close(); audioContext = null; }
    if(mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream = null; }
    if(ws){ ws.close(); ws = null; }
    buffer = new Float32Array(0);
    micBtn.textContent = '🎤';
  }
  micBtn.onclick = ()=>{ if(micOn) stopMic(); else startMic(); };

  // ====== localStorage（带人设） ======
  function populatePersonaOptions(){
    personaSelect.innerHTML = '';
    for(const [key, val] of Object.entries(PERSONAS)){
      const opt = document.createElement('option');
      opt.value = key; opt.textContent = val.label;
      if(key === currentPersonaKey) opt.selected = true;
      personaSelect.appendChild(opt);
    }
  }

  function greetByPersona(){
    const p = PERSONAS[currentPersonaKey];
    addMessage('assistant', p.greeting);
  }

  function saveHistory(){
    localStorage.setItem('chatHistory', chat.innerHTML);
    localStorage.setItem('personaKey', currentPersonaKey);
  }

  function loadHistory(){
    const savedPersona = localStorage.getItem('personaKey');
    if(savedPersona && PERSONAS[savedPersona]) currentPersonaKey = savedPersona;
    populatePersonaOptions();

    const h = localStorage.getItem('chatHistory');
    if(h){
      chat.innerHTML = h;
      // 说明：直接还原 innerHTML 会丢失“朗读按钮”的事件绑定；
      // 为简化，这里不做事件重绑，建议手动发新消息开始新一轮会话。
    } else {
      greetByPersona();
    }
  }

  resetBtn.onclick = () => {
    chat.innerHTML = '';
    localStorage.removeItem('chatHistory');
    greetByPersona();
  };

  personaSelect.onchange = () => {
    currentPersonaKey = personaSelect.value;
    localStorage.setItem('personaKey', currentPersonaKey);
    // 切换人设时，重新开始一轮对话：清空并发送该人设的开场白
    chat.innerHTML = '';
    localStorage.removeItem('chatHistory');
    greetByPersona();
  };

  // ====== 初始化 ======
  loadHistory();
  if(!chat.innerHTML){ greetByPersona(); }


  
</script>
</body>
</html>